<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Viva Sorte</title>

  <!-- Estilos -->
  <link rel="stylesheet" href="./css/modalpix.css">
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/bootstrap.min.css" crossorigin="anonymous">
  <link rel="stylesheet" href="css/bootstrap-icons.min.css">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
</head>
<body>
  <!-- Conteúdo principal do site -->

  <!-- Modal Pix -->
  <div id="pixModal">
    <div class="modal-content-1">

      <!-- Formulário inicial -->
      <div id="formSection">
        <h3>Antes, precisamos que informe seus dados:</h3>
        <input type="text" id="nome" placeholder="Nome completo" required>
        <input type="tel" id="whatsapp" placeholder="WhatsApp (somente números)" required>
        <input type="text" id="cpf" placeholder="CPF (somente números)" required>
        <button id="gerarBtn" onclick="gerarPix()">Gerar Pagamento</button>
      </div>

      <!-- Dados do Pix -->
      <div id="pixData">
        <h3>Pagamento via Pix</h3>
        <img id="qrcode" src="" alt="QR Code do Pix" />
        <p><strong>Valor:</strong> <span id="valor"></span></p>
        <p><strong>Chave Pix:</strong></p>
        <textarea id="pixCode" readonly></textarea>
        <button id="copiarBtn" style="margin-top: 10px;" onclick="copiarPix()">Copiar</button>
        <p id="aguardandoStatus" style="margin-top: 15px;">⏳ Aguardando pagamento...</p>
      </div>

      <!-- Tela de espera -->
      <div id="wait">
        <h3>Pagamento via Pix</h3>
        <img src="./images/loading.gif" alt="Carregando...">
        <p id="waitStatus" style="margin-top: 15px; font-size: 1rem; font-weight: bold;">
          ⏳ Pagamento está sendo gerado!
        </p>
      </div>
    </div>
  </div>

  <!-- Script de integração Pix -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const precoPorUnidade = (typeof window.precoPorUnidade !== 'undefined') ? window.precoPorUnidade : 0.99;
    const redirectUrl = (typeof window.redirectUrl !== 'undefined') ? window.redirectUrl : "./ups/up1/";

    function calcularValorEmCentavos() {
      if (typeof window.valorGlobal !== 'undefined' && Number(window.valorGlobal) > 0) {
        return Number(window.valorGlobal);
      }
      const numeroEl = document.getElementById('numero');
      const qtd = numeroEl ? parseInt(numeroEl.value || 0, 10) : 0;
      if (!qtd || qtd <= 0) return 0;
      return Math.round(qtd * precoPorUnidade * 100);
    }

    function soNumeros(s){ return (s||'').toString().replace(/\D/g,''); }

    window.gerarPix = async function() {
      const nome = (document.getElementById('nome')||{}).value || '';
      const whatsappRaw = (document.getElementById('whatsapp')||{}).value || '';
      const cpfRaw = (document.getElementById('cpf')||{}).value || '';
      const whatsapp = soNumeros(whatsappRaw);
      const cpf = soNumeros(cpfRaw);
      const valor = calcularValorEmCentavos();

      if (!nome || nome.length < 3) { alert('Preencha o nome corretamente.'); return; }
      if (!whatsapp || whatsapp.length < 10) { alert('Preencha o WhatsApp corretamente.'); return; }
      if (!cpf || cpf.length !== 11) { alert('Preencha o CPF com 11 dígitos.'); return; }
      if (!valor || valor <= 0) { alert('Selecione uma cota antes de gerar o pagamento.'); return; }

      const formSection = document.getElementById('formSection');
      const wait = document.getElementById('wait');
      const pixData = document.getElementById('pixData');
      if (formSection) formSection.style.display = 'none';
      if (pixData) pixData.style.display = 'none';
      if (wait) wait.style.display = 'block';

      try {
        // Envio em FormData para compatibilidade com PHP ($_POST)
        const fd = new FormData();
        fd.append('nome', nome.trim());
        fd.append('whatsapp', whatsapp);
        fd.append('cpf', cpf);
        fd.append('valor', valor);

        const resp = await fetch('./gerar.php', {
          method: 'POST',
          headers: { 'Accept': 'application/json' },
          body: fd,
          credentials: 'same-origin'
        });

        if (!resp.ok) {
          const text = await resp.text();
          throw new Error('Erro HTTP ' + resp.status + ': ' + text);
        }

        const text = await resp.text();
        let data;
        try { data = JSON.parse(text); } 
        catch { throw new Error('Resposta inválida do servidor: ' + text); }

        if (data.error) throw new Error(data.error);

        if (pixData) pixData.style.display = 'block';
        if (wait) wait.style.display = 'none';

        document.getElementById('pixCode').value = data.pixcode || '';
        document.getElementById('qrcode').src = data.pixqrcode || '';
        document.getElementById('valor').innerText = (valor/100).toFixed(2).replace('.',',');

        if (data.id_transaction) verificarStatus(data.id_transaction);
      } catch (err) {
        console.error('Erro ao gerar PIX:', err);
        alert('Erro ao gerar pagamento: ' + (err.message || err));
        if (formSection) formSection.style.display = 'block';
        if (wait) wait.style.display = 'none';
      }
    };

    async function verificarStatus(transactionId) {
      const statusEl = document.getElementById('aguardandoStatus');
      const interval = setInterval(async () => {
        try {
          const resp = await fetch('./status.php?transaction_id=' + encodeURIComponent(transactionId), {
            headers: { 'Accept': 'application/json' },
            credentials: 'same-origin'
          });
          if (!resp.ok) return;

          const text = await resp.text();
          let data;
          try { data = JSON.parse(text); } 
          catch { return; }

          const status = (data.status || '').toLowerCase();
          if (status === 'paid' || status === 'pago') {
            clearInterval(interval);
            if (statusEl) statusEl.innerText = '✅ Pagamento confirmado!';
            setTimeout(() => window.location.href = redirectUrl, 1500);
          }
        } catch (err) {
          console.error('Erro ao consultar status:', err);
        }
      }, 5000);
    }

    window.copiarPix = async function() {
      const pixInput = document.getElementById('pixCode');
      if (!pixInput) return;
      const text = pixInput.value || '';
      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(text);
        } else {
          pixInput.select();
          document.execCommand('copy');
        }
        alert('Código PIX copiado!');
      } catch (err) {
        alert('Não foi possível copiar automaticamente. Copie manualmente.');
      }
    };

    // Inicialização
    if (document.getElementById('pixData')) document.getElementById('pixData').style.display = 'none';
    if (document.getElementById('wait')) document.getElementById('wait').style.display = 'none';
  });
  </script>

  <!-- Scripts Bootstrap -->
  <script src="js/bootstrap.bundle.min.js"></script>
</body>
</html>
