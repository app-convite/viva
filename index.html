<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Viva Sorte</title>

  <!-- Estilos -->
  <link rel="stylesheet" href="./css/modalpix.css">
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/bootstrap.min.css" crossorigin="anonymous">
  <link rel="stylesheet" href="css/bootstrap-icons.min.css">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

  <style>
    /* Estilo mínimo para modal aparecer centralizado */
    #pixModal {
      display: none;
      position: fixed;
      z-index: 9999;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
    }
    .modal-content-1 {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      width: 100%;
      max-width: 400px;
    }
    input, textarea {
      width: 100%;
      margin: 6px 0;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    button {
      width: 100%;
      margin-top: 10px;
      padding: 10px;
      background: #28a745;
      border: none;
      color: #fff;
      border-radius: 8px;
      cursor: pointer;
    }
    button:hover {
      background: #218838;
    }
  </style>
</head>
<body>
  <div class="container text-center mt-5">
    <h1>Teste de Pagamento PIX</h1>
    <p>Clique no botão abaixo para abrir o modal e gerar um PIX de teste.</p>
    <button onclick="document.getElementById('pixModal').style.display='flex'">Abrir Modal PIX</button>
  </div>

  <!-- Modal Pix -->
  <div id="pixModal">
    <div class="modal-content-1">
      <!-- Formulário inicial -->
      <div id="formSection">
        <h3>Informe seus dados:</h3>
        <input type="text" id="nome" placeholder="Nome completo" required>
        <input type="tel" id="whatsapp" placeholder="WhatsApp (somente números)" required>
        <input type="text" id="cpf" placeholder="CPF (somente números)" required>
        <button id="gerarBtn" onclick="gerarPix()">Gerar Pagamento</button>
      </div>

      <!-- Dados do Pix -->
      <div id="pixData">
        <h3>Pagamento via Pix</h3>
        <img id="qrcode" src="" alt="QR Code do Pix" />
        <p><strong>Valor:</strong> <span id="valor"></span></p>
        <p><strong>Chave Pix:</strong></p>
        <textarea id="pixCode" readonly></textarea>
        <button id="copiarBtn" onclick="copiarPix()">Copiar Código</button>
        <p id="aguardandoStatus" style="margin-top: 15px;">⏳ Aguardando pagamento...</p>
      </div>

      <!-- Tela de espera -->
      <div id="wait">
        <h3>Gerando pagamento...</h3>
        <img src="./images/loading.gif" alt="Carregando...">
        <p id="waitStatus" style="margin-top: 15px; font-size: 1rem; font-weight: bold;">
          ⏳ Pagamento está sendo gerado!
        </p>
      </div>

      <button style="background:#dc3545;margin-top:15px;" onclick="document.getElementById('pixModal').style.display='none'">Fechar</button>
    </div>
  </div>

  <!-- Script de integração Pix -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const precoPorUnidade = 0.99; // valor padrão
    const redirectUrl = "./ups/up1/";

    function calcularValorEmCentavos() {
      return Math.round(precoPorUnidade * 100);
    }

    function soNumeros(s){ return (s||'').toString().replace(/\D/g,''); }

    window.gerarPix = async function() {
      const nome = (document.getElementById('nome')||{}).value || '';
      const whatsappRaw = (document.getElementById('whatsapp')||{}).value || '';
      const cpfRaw = (document.getElementById('cpf')||{}).value || '';
      const whatsapp = soNumeros(whatsappRaw);
      const cpf = soNumeros(cpfRaw);
      const valor = calcularValorEmCentavos();

      if (!nome || nome.length < 3) { alert('Preencha o nome corretamente.'); return; }
      if (!whatsapp || whatsapp.length < 10) { alert('Preencha o WhatsApp corretamente.'); return; }
      if (!cpf || cpf.length !== 11) { alert('Preencha o CPF com 11 dígitos.'); return; }
      if (!valor || valor <= 0) { alert('Valor inválido.'); return; }

      const formSection = document.getElementById('formSection');
      const wait = document.getElementById('wait');
      const pixData = document.getElementById('pixData');
      if (formSection) formSection.style.display = 'none';
      if (pixData) pixData.style.display = 'none';
      if (wait) wait.style.display = 'block';

      try {
        const fd = new FormData();
        fd.append('nome', nome.trim());
        fd.append('whatsapp', whatsapp);
        fd.append('cpf', cpf);
        fd.append('valor', valor);

        const resp = await fetch('./gerar.php', {
          method: 'POST',
          headers: { 'Accept': 'application/json' },
          body: fd
        });

        if (!resp.ok) {
          const text = await resp.text();
          throw new Error('Erro HTTP ' + resp.status + ': ' + text);
        }

        const text = await resp.text();
        let data;
        try { data = JSON.parse(text); } 
        catch { throw new Error('Resposta inválida: ' + text); }

        if (data.error) throw new Error(data.error);

        if (pixData) pixData.style.display = 'block';
        if (wait) wait.style.display = 'none';

        document.getElementById('pixCode').value = data.pixcode || '';
        document.getElementById('qrcode').src = data.pixqrcode || '';
        document.getElementById('valor').innerText = (valor/100).toFixed(2).replace('.',',');

      } catch (err) {
        console.error('Erro ao gerar PIX:', err);
        alert('Erro ao gerar pagamento: ' + (err.message || err));
        if (formSection) formSection.style.display = 'block';
        if (wait) wait.style.display = 'none';
      }
    };

    window.copiarPix = async function() {
      const pixInput = document.getElementById('pixCode');
      if (!pixInput) return;
      const text = pixInput.value || '';
      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(text);
        } else {
          pixInput.select();
          document.execCommand('copy');
        }
        alert('Código PIX copiado!');
      } catch (err) {
        alert('Não foi possível copiar automaticamente. Copie manualmente.');
      }
    };

    // Estado inicial
    if (document.getElementById('pixData')) document.getElementById('pixData').style.display = 'none';
    if (document.getElementById('wait')) document.getElementById('wait').style.display = 'none';
  });
  </script>

  <!-- Scripts Bootstrap -->
  <script src="js/bootstrap.bundle.min.js"></script>
</body>
</html>
